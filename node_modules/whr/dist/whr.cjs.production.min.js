"use strict";function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function e(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}function n(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}function i(t){return(i=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function r(t,e){return(r=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function o(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}function a(t,e,n){return(a=o()?Reflect.construct:function(t,e,n){var i=[null];i.push.apply(i,e);var o=new(Function.bind.apply(t,i));return n&&r(o,n.prototype),o}).apply(null,arguments)}function s(t){var e="function"==typeof Map?new Map:void 0;return(s=function(t){if(null===t||-1===Function.toString.call(t).indexOf("[native code]"))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,n)}function n(){return a(t,arguments,i(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),r(n,t)})(t)}Object.defineProperty(exports,"__esModule",{value:!0});var h=function(){function t(t,e){this.player=t,this.day=e,this.isFirstDay=!1,this.wonGames=[],this.lostGames=[],this._wonGameTerms=null,this._lostGameTerms=null,this.uncertainty=null}var n=t.prototype;return n.clearGameTermsCache=function(){this._wonGameTerms=null,this._lostGameTerms=null},n.addGame=function(t){"W"==t.winner&&t.whitePlayer===this.player||"B"==t.winner&&t.blackPlayer===this.player?this.wonGames.push(t):this.lostGames.push(t)},n.updateBy1DNewtonsMethod=function(){this.r=this.r-this.logLikelihoodDerivative/this.logLikelihoodSecondDerivative},e(t,[{key:"gamma",set:function(t){this.r=Math.log(t)},get:function(){return Math.exp(this.r)}},{key:"elo",set:function(t){this.r=t*(Math.log(10)/400)},get:function(){return 400*this.r/Math.log(10)}},{key:"logLikelihood",get:function(){return 0}},{key:"wonGameTerms",get:function(){var t=this;return this._wonGameTerms||(this._wonGameTerms=this.wonGames.map((function(e){var n=e.opponentsAdjustedGamma(t.player);if(0===n||isNaN(n)||!isFinite(n))throw new f("otherGamma ("+e.opponent(t.player).inspect+") = "+n);return[1,0,1,n]})),this.isFirstDay&&this._wonGameTerms.push([1,0,1,1])),this._wonGameTerms}},{key:"lostGameTerms",get:function(){var t=this;return this._lostGameTerms||(this._lostGameTerms=this.lostGames.map((function(e){var n=e.opponentsAdjustedGamma(t.player);return 0!==n&&!isNaN(n)&&isFinite(n)||console.log("otherGamma ("+e.opponent(t.player).inspect+") = "+n),[0,n,1,n]})),this.isFirstDay&&this._lostGameTerms.push([0,1,1,1])),this._lostGameTerms}},{key:"logLikelihoodSecondDerivative",get:function(){var t=this,e=0;if(this.wonGameTerms.concat(this.lostGameTerms).forEach((function(n){var i=n[2],r=n[3];e+=i*r/Math.pow(i*t.gamma+r,2)})),isNaN(this.gamma))throw new f("Gamma cannot be NaN");if(isNaN(e))throw new f("Sum cannot be NaN");return-1*this.gamma*e}},{key:"logLikelihoodDerivative",get:function(){var t=this,e=0;return this.wonGameTerms.concat(this.lostGameTerms).forEach((function(n){var i=n[2];e+=i/(i*t.gamma+n[3])})),this.wonGameTerms.length-this.gamma*e}}]),t}(),u=function(){function t(t,e){this.name=t,this.days=[],this.debug=e.debug,this.w2=Math.pow(Math.sqrt(e.w2)*Math.log(10)/400,2)}var n=t.prototype;return n.hessian=function(t,e){var n=t.length;return new Array(n).fill(new Array(n).fill(null)).map((function(i,r){return i.map((function(i,o){if(r==o){var a=0;return r<n-1&&(a+=-1/e[r]),r>0&&(a+=-1/e[r-1]),t[r].logLikelihoodSecondDerivative+a-.001}return r==o-1?1/e[r]:r==o+1?1/e[o]:0}))}))},n.gradient=function(t,e,n){var i=this,r=[],o=this.days.length;return e.forEach((function(e,a){var s=0;a<o-1&&(s+=-(t[a]-t[a+1])/n[a]),a>0&&(s+=-(t[a]-t[a-1])/n[a-1]),i.debug&&console.log("g["+a+"] = "+e.logLikelihoodDerivative+" + "+s),r.push(e.logLikelihoodDerivative+s)})),r},n.runOneNewtonIteration=function(){this.days.forEach((function(t){t.clearGameTermsCache()})),1==this.days.length?this.days[0].updateBy1DNewtonsMethod():this.days.length>1&&this.updateByNDimNewton()},n.computeSigma2=function(){var t=this,e=[];return this.days.forEach((function(n,i){0!=i&&e.push(Math.abs(t.days[i-1].day-n.day)*t.w2)})),e},n.updateByNDimNewton=function(){var t=this,e=this.days.map((function(t){return t.r}));this.debug&&(console.log("Updating "+this.inspect),this.days.forEach((function(t){console.log("day["+t.day+"] r = "+t.r),console.log("day["+t.day+"] win terms = "+t.wonGameTerms),console.log("day["+t.day+"] win games = "+t.wonGames),console.log("day["+t.day+"] lose terms = "+t.lostGameTerms),console.log("day["+t.day+"] lost games = "+t.lostGames),console.log("day["+t.day+"] log(p) = "+t.logLikelihood),console.log("day["+t.day+"] dlp = "+t.logLikelihoodDerivative),console.log("day["+t.day+"] dlp2 = "+t.logLikelihoodSecondDerivative)})));for(var n=this.computeSigma2(),i=this.hessian(this.days,n),r=this.gradient(e,this.days,n),o=[],a=[i[0][0]],s=[i[0][1]],h=e.length,u=1;u<h;u++)o[u]=i[u][u-1]/a[u-1],a[u]=i[u][u]-o[u]*s[u-1],s[u]=i[u][u+1];for(var l=[r[0]],c=1;c<h;c++)l[c]=r[c]-o[c]*l[c-1];var p=[];p[h-1]=l[h-1]/a[h-1];for(var y=h-2;y>=0;y--)p[y]=(l[y]-s[y]*p[y+1])/a[y];var m=o.map((function(t,e){return[t,p[e]]})).map((function(t){return t[0]-t[1]}));m.forEach((function(e){if(e>650)throw new f("Unstable r ("+m+") on player "+t.inspect)})),this.debug&&(console.log("Hessian = "+i),console.log("gradient = "+r),console.log("a = "+o),console.log("d = "+a),console.log("b = "+s),console.log("y = "+l),console.log("x = "+p),console.log(this.inspect+" ("+e+") => ("+m+")")),this.days.forEach((function(t,e){t.r=t.r-p[e]}))},n.updateUncertainty=function(){if(this.days.length>0){var t=this.covariance,e=this.days.map((function(e,n){return t[n][n]}));return this.days.map((function(t,n){return[t,e[n]]})).map((function(t){return t[0].uncertainty=t[1]}))}return 5},n.addGame=function(t){var e=this.days.slice(-1)[0];if(!e||e.day!=t.day){var n=new h(this,t.day);0==this.days.length?(n.isFirstDay=!0,n.gamma=1):n.gamma=e.gamma,e=n,this.days.push(n)}t.whitePlayer===this?t.wpd=e:t.bpd=e,e.addGame(t)},e(t,[{key:"inspect",get:function(){return"<Player:"+Object.entries(this).map((function(t){return t[0]+"="+t[1]})).join(",")+">"}},{key:"logLikelihood",get:function(){for(var t=0,e=this.computeSigma2(),n=this.days,i=n.length,r=0;r<i;r++){var o=0;if(r<i){var a=n[r].r-n[r+1].r;o+=1/Math.sqrt(2*Math.PI*e[r])*Math.exp(-Math.pow(a,2)/2*e[r])}if(r>0){var s=n[r].r-n[r-1].r;o+=1/Math.sqrt(2*Math.PI*e[r-1])*Math.exp(-Math.pow(s,2)/2*e[r-1])}if(0==o)t+=n[r].logLikelihood;else{if(!isFinite(n[r].logLikelihood)||!isFinite(Math.log(o)))throw new f("Infinity at "+this.inspect+": "+n[r].logLikelihood+" + "+Math.log(o)+": prior = "+o+", days = "+JSON.stringify(this.days));t+=n[r].logLikelihood+Math.log(o)}}return t}},{key:"covariance",get:function(){var t,e=this.days.map((function(t){return t.r})),n=this.computeSigma2(),i=this.hessian(this.days,n),r=[],o=[i[0][0]],a=[i[0][1]];t=e.length;for(var s=1;s<t;s++)r[s]=i[s][s-1]/o[s-1],o[s]=i[s][s]-r[s]*a[s-1],a[s]=i[s][s+1];var h=[];h[t-1]=i[t-1][t-1];var u=[];u[t-1]=i[t-1][t-2];for(var l=[],c=t-2;c>=0;c--)l[c]=i[c][c+1]/h[c+1],h[c]=i[c][c]-l[c]*u[c+1],u[c]=i[c][c-1];for(var f=[],p=0;p<t-1;p++)f[p]=h[p+1]/(a[p]*u[p+1]-o[p]*h[p+1]);return f[t-1]=-1/o[t-1],new Array(t).fill(new Array(t).fill(null)).map((function(t,e){return t.map((function(t,n){return e==n?f[e]:e==n-1?-1*r[n]*f[n]:0}))}))}}]),t}(),l=function(){function t(t,e,n,i,r,o){this.day=i,this.whitePlayer=e,this.blackPlayer=t,this.winner=n,this._handicap=r||0,this.wpd=null,this.bpd=null,this.extras=o||{}}var n=t.prototype;return n.opponentsAdjustedGamma=function(t){var e,n=this.handicap;if(t===this.whitePlayer)e=this.bpd.elo+n;else{if(t!==this.blackPlayer)throw new c("No opponent for "+t.name+", since they're not in this game: "+this+".");e=this.wpd.elo-n}var i=Math.pow(10,e/400);if(0==i||!isFinite(i)||isNaN(i))throw new f("Bad adjusted gamma: "+this);return i},n.opponent=function(t){return t==this.whitePlayer?this.blackPlayer:this.whitePlayer},e(t,[{key:"inspect",get:function(){return"<Game:"+Object.entries(this).map((function(t){return t[0]+"="+t[1]})).join(",")+">"}},{key:"handicap",get:function(){return this._handicap instanceof Function?this._handicap():this._handicap}},{key:"predictionScore",get:function(){return.5==this.whiteWinProbability?.5:"W"==this.winner&&this.whiteWinProbability>.5||"B"==this.winner&&this.whiteWinProbability<.5?1:0}},{key:"whiteWinProbability",get:function(){return this.wpd.gamma/(this.wpd.gamma+this.opponentsAdjustedGamma(this.whitePlayer))}},{key:"blackWinProbability",get:function(){return this.bpd.gamma/(this.bpd.gamma+this.opponentsAdjustedGamma(this.blackPlayer))}}]),t}(),c=function(t){function e(){return t.apply(this,arguments)||this}return n(e,t),e}(s(Error)),f=function(t){function e(){return t.apply(this,arguments)||this}return n(e,t),e}(c),p=function(){function t(t){this.config=t||{},this.config.w2=this.config.w2||300,this.games=this.config.games||[],this.players=this.config.players||new Map}var n=t.prototype;return n.printOrderedRatings=function(){Array.from(this.players.values()).filter((function(t){return t.days.length>0})).forEach((function(t){return console.log(t.name+" => "+t.days.map((function(t){return t.elo})).join(", "))}))},n.logLikelihood=function(){var t=0;return Object.values(this.players).forEach((function(e){e.days.length>0&&(t+=e.logLikelihood)})),t},n.playerByName=function(t){var e=this.players.get(t);return e||(e=new u(t,this.config),this.players.set(t,e)),e},n.ratingsForPlayer=function(t){return this.playerByName(t).days.map((function(t){return[t.day,Math.round(t.elo),Math.round(100*t.uncertainty)]}))},n.setupGame=function(t,e,n,i,r,o){if(void 0===o&&(o={}),t==e)throw new c("Invalid game, player cannot play with themself");var a=this.playerByName(e),s=this.playerByName(t);return new l(s,a,n,i,r,o)},n.createGame=function(t,e,n,i,r,o){void 0===o&&(o={});var a=this.setupGame(t,e,n,i,r,o);return this.addGame(a)},n.addGame=function(t){if(t.whitePlayer.addGame(t),t.blackPlayer.addGame(t),!t.bpd)throw new c("Bad game: "+t.inspect);return this.games.push(t),t},n.iterate=function(t){for(var e=0;e<t;e++)this.runOneIteration();this.players.forEach((function(t){return t.updateUncertainty()}))},n.runOneIteration=function(){this.players.forEach((function(t){return t.runOneNewtonIteration()}))},e(t,[{key:"inspect",get:function(){return this}}]),t}();exports.Game=l,exports.Player=u,exports.PlayerDay=h,exports.WholeHistoryRating=p;
//# sourceMappingURL=whr.cjs.production.min.js.map
